{% extends "base.html" %}

{% block title %}Панель администратора{% endblock %}

{% block content %}
<style>
    .admin-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: transform 0.4s ease, box-shadow 0.4s ease;
        margin-bottom: 1.5rem;
    }

    .admin-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.3);
    }

    .card-header {
        border-radius: 12px 12px 0 0 !important;
        font-weight: 600;
    }

    .table-responsive {
        border-radius: 8px;
        overflow: hidden;
    }

    .table th {
        background: #f8f9fa;
        font-weight: 600;
    }

    .badge {
        font-size: 0.75em;
    }

    .btn {
        transition: all 0.3s ease;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Панель администратора</h1>
</div>

<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card admin-card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Загрузка студентов</h5>
            </div>
            <div class="card-body">
                <form id="uploadStudentsForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label class="form-label">Файл (Excel/CSV):</label>
                        <input type="file" class="form-control" name="file" accept=".xlsx,.xls,.csv" required>
                        <small class="form-text text-muted">Колонки: "full_name", "group", "phone", "cmk"</small>
                    </div>
                    <button type="submit" class="btn btn-success">Загрузить студентов</button>
                </form>
                <div id="studentsMessage" class="mt-2"></div>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card admin-card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Загрузка тем</h5>
            </div>
            <div class="card-body">
                <form id="uploadTopicsForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label class="form-label">Файл (Excel/CSV):</label>
                        <input type="file" class="form-control" name="file" accept=".xlsx,.xls,.csv" required>
                        <small class="form-text text-muted">Колонки: "title", "supervisor", "work_type", "subject"</small>
                    </div>
                    <button type="submit" class="btn btn-info">Загрузить темы</button>
                </form>
                <div id="topicsMessage" class="mt-2"></div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card admin-card">
            <div class="card-header bg-warning">
                <h5 class="mb-0">Автоматическое распределение</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <select class="form-select" id="distributionGroup">
                            <option value="">Выберите группу</option>
                            {% for group in groups %}
                            <option value="{{ group.id }}">{{ group.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="distributionWorkType">
                            <option value="">Тип работы</option>
                            {% for work_type in work_types %}
                            <option value="{{ work_type.id }}">{{ work_type.name }} - {{ work_type.subject }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-warning w-100" onclick="randomDistribute()">Случайное распределение</button>
                    </div>
                </div>
                <div id="distributionMessage" class="mt-2"></div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card admin-card">
            <div class="card-header"><h5>Студенты ({{ students|length }})</h5></div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead><tr><th>ФИО</th><th>Группа</th><th>Телефон</th><th>Тема</th></tr></thead>
                        <tbody>
                            {% for s in students %}
                            <tr>
                                <td>{{ s.full_name }}</td>
                                <td>{{ s.group.name }}</td>
                                <td>{{ s.phone or '-' }}</td>
                                <td>
                                    {% if s.topic %}{{ s.topic.title[:40] }}...{% else %}<span class="text-muted">Не назначена</span>{% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card admin-card">
            <div class="card-header"><h5>Темы ({{ topics|length }})</h5></div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead><tr><th>Тема</th><th>Руководитель</th><th>Тип</th><th>Статус</th></tr></thead>
                        <tbody>
                            {% for t in topics %}
                            <tr>
                                <td>{{ t.title[:40] }}...</td>
                                <td>{{ t.supervisor.full_name }}</td>
                                <td>{{ t.work_type.name }}</td>
                                <td>
                                    {% if t.status == 'free' %}
                                        <span class="badge bg-success">Свободна</span>
                                    {% else %}
                                        <span class="badge bg-primary">Назначена</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('uploadStudentsForm').addEventListener('submit', e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    fetch('/admin/upload_students', {method:'POST', body:fd}).then(r=>r.json()).then(d=>{
        const el = document.getElementById('studentsMessage');
        el.innerHTML = d.success ? `<div class="alert alert-success">${d.success}</div>` : `<div class="alert alert-danger">${d.error}</div>`;
        if(d.success) setTimeout(()=>location.reload(),2000);
    });
});

document.getElementById('uploadTopicsForm').addEventListener('submit', e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    fetch('/admin/upload_topics', {method:'POST', body:fd}).then(r=>r.json()).then(d=>{
        const el = document.getElementById('topicsMessage');
        el.innerHTML = d.success ? `<div class="alert alert-success">${d.success}</div>` : `<div class="alert alert-danger">${d.error}</div>`;
        if(d.success) setTimeout(()=>location.reload(),2000);
    });
});

function randomDistribute() {
    const g = document.getElementById('distributionGroup').value;
    const w = document.getElementById('distributionWorkType').value;
    if(!g||!w) return alert('Выберите группу и тип');
    fetch('/admin/random_distribute', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({group_id:g, work_type_id:w})
    }).then(r=>r.json()).then(d=>{
        const el = document.getElementById('distributionMessage');
        el.innerHTML = d.success ? `<div class="alert alert-success">${d.success}</div>` : `<div class="alert alert-danger">${d.error}</div>`;
        if(d.success) setTimeout(()=>location.reload(),2000);
    });
}
</script>
{% endblock %}